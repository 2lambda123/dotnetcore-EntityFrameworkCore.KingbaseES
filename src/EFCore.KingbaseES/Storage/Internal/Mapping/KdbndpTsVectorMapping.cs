using System.Text;

namespace Kdbndp.EntityFrameworkCore.KingbaseES.Storage.Internal.Mapping;

/// <summary>
///     This is an internal API that supports the Entity Framework Core
///     infrastructure and not subject to the same compatibility standards as
///     public APIs. It may be changed or removed without notice in any release.
///     You should only use it directly in your code with extreme caution and
///     knowing that doing so can result in application failures when updating
///     to a new Entity Framework Core release.
/// </summary>
public class KdbndpTsVectorTypeMapping : KdbndpTypeMapping {
  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  public static KdbndpTsVectorTypeMapping Default { get; } = new();

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  public KdbndpTsVectorTypeMapping()
      : base("tsvector", typeof(KdbndpTsVector), KdbndpDbType.TsVector) {}

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  protected KdbndpTsVectorTypeMapping(
      RelationalTypeMappingParameters parameters)
      : base(parameters, KdbndpDbType.TsVector) {}

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  protected override
      RelationalTypeMapping Clone(RelationalTypeMappingParameters parameters) =>
          new KdbndpTsVectorTypeMapping(parameters);

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  protected override string GenerateNonNullSqlLiteral(object value) {
    Check.NotNull(value, nameof(value));
    var vector = (KdbndpTsVector)value;
    var builder = new StringBuilder();
    builder.Append("TSVECTOR  ");
    var indexOfFirstQuote = builder.Length - 1;
    builder.Append(vector);
    builder.Replace("'", "''");
    builder[indexOfFirstQuote] = '\'';
    builder.Append("'");
    return builder.ToString();
  }
}
