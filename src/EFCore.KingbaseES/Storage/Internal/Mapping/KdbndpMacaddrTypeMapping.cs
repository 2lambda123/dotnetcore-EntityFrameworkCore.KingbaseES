using System.Net.NetworkInformation;
using Kdbndp.EntityFrameworkCore.KingbaseES.Storage.Internal.Json;

namespace Kdbndp.EntityFrameworkCore.KingbaseES.Storage.Internal.Mapping;

/// <summary>
///     The type mapping for the KingbaseES macaddr type.
/// </summary>
/// <remarks>
///     See:
///     https://www.KingbaseES.org/docs/current/static/datatype-net-types.html#DATATYPE-MACADDR
/// </remarks>
public class KdbndpMacaddrTypeMapping : KdbndpTypeMapping {
  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  public static KdbndpMacaddrTypeMapping Default { get; } = new();

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  public KdbndpMacaddrTypeMapping()
      : base("macaddr", typeof(PhysicalAddress), KdbndpDbType.MacAddr,
             jsonValueReaderWriter: JsonMacaddrReaderWriter.Instance) {}

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  protected KdbndpMacaddrTypeMapping(RelationalTypeMappingParameters parameters)
      : base(parameters, KdbndpDbType.MacAddr) {}

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  protected override
      RelationalTypeMapping Clone(RelationalTypeMappingParameters parameters) =>
          new KdbndpMacaddrTypeMapping(parameters);

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  protected override string GenerateNonNullSqlLiteral(object value) =>
      $"MACADDR '{(PhysicalAddress)value}'";

  /// <summary>
  ///     This is an internal API that supports the Entity Framework Core
  ///     infrastructure and not subject to the same compatibility standards as
  ///     public APIs. It may be changed or removed without notice in any
  ///     release. You should only use it directly in your code with extreme
  ///     caution and knowing that doing so can result in application failures
  ///     when updating to a new Entity Framework Core release.
  /// </summary>
  public override Expression GenerateCodeLiteral(object value) =>
      Expression.Call(ParseMethod,
                      Expression.Constant(((PhysicalAddress)value).ToString()));

  private static readonly MethodInfo ParseMethod =
      typeof(PhysicalAddress).GetMethod("Parse", new[] { typeof(string) })!;
}
